<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hammaga Yetadi Color</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <style>
        :root { --primary: #3390ec; --bg: #ffffff; --text: #000000; --card: #f4f4f5; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            margin: 0; padding: 16px; display: flex; flex-direction: column; align-items: center;
        }
        .preview {
            width: 100%; height: 120px; border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
            transition: background 0.2s; position: relative;
        }
        .hex-title {
            position: absolute; bottom: 10px; right: 15px; background: rgba(0,0,0,0.5);
            color: #fff; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-size: 14px;
        }
        .card {
            background: var(--tg-theme-secondary-bg-color, var(--card));
            width: 100%; border-radius: 12px; padding: 15px; box-sizing: border-box; margin-bottom: 15px;
        }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .label { opacity: 0.6; } .val { font-weight: 600; font-family: monospace; }
        
        .tabs { display: flex; width: 100%; gap: 10px; margin-bottom: 15px; }
        .tab { 
            flex: 1; padding: 10px; text-align: center; background: var(--tg-theme-secondary-bg-color, #eee);
            border-radius: 10px; cursor: pointer; font-weight: 500; transition: 0.2s;
        }
        .tab.active { background: var(--primary); color: white; }
        
        input[type="color"] { width: 100%; height: 50px; border: none; background: none; cursor: pointer; }
        .hidden { display: none; }
        
        .btn-upload {
            display: flex; justify-content: center; align-items: center; width: 100%;
            padding: 12px; background: var(--primary); color: white; border-radius: 10px;
            cursor: pointer; font-weight: bold;
        }
        canvas { max-width: 100%; border-radius: 8px; margin-top: 15px; display: none; }
        
        .palette { display: flex; gap: 8px; margin-top: 15px; overflow-x: auto; padding-bottom: 5px; }
        .p-item { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="setTab('solid')">ðŸŽ¨ Palitra</div>
        <div class="tab" onclick="setTab('image')">ðŸ“· Rasm</div>
    </div>

    <div class="preview" id="previewBox" style="background: #3390EC;">
        <div class="hex-title" id="hexDisplay">#3390EC</div>
    </div>

    <div class="card">
        <div class="row"><span class="label">RGB</span><span class="val" id="rgbVal">51, 144, 236</span></div>
        <div class="row"><span class="label">HSL</span><span class="val" id="hslVal">210, 82%, 56%</span></div>
        <div class="row"><span class="label">CMYK</span><span class="val" id="cmykVal">78, 39, 0, 7</span></div>
    </div>

    <div id="solidSec" class="card">
        <label style="margin-bottom:10px; display:block; opacity:0.7">Rangni tanlang:</label>
        <input type="color" id="nativeColor" value="#3390ec">
    </div>

    <div id="imageSec" class="card hidden">
        <label class="btn-upload">
            ðŸ“¤ Rasm Yuklash
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </label>
        <canvas id="canvas"></canvas>
        <div class="palette" id="paletteBox"></div>
        <p style="text-align:center; font-size:12px; color:gray; margin-top:10px">Rasm ustiga bosib rangni oling</p>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // Full screen qilish
    const colorThief = new ColorThief();
    
    let currentData = { hex: "#3390EC", rgb: "51, 144, 236", hsl: "210, 82%, 56%", cmyk: "78, 39, 0, 7" };

    // Asosiy tugmani sozlash
    tg.MainButton.text = "âœ… TANLANGAN RANGNI YUBORISH";
    tg.MainButton.show();
    tg.MainButton.onClick(() => {
        tg.sendData(JSON.stringify(currentData));
    });

    const preview = document.getElementById('previewBox');
    const hexDisplay = document.getElementById('hexDisplay');
    const nativeColor = document.getElementById('nativeColor');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Tablar o'rtasida o'tish
    function setTab(mode) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(mode === 'solid') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('solidSec').classList.remove('hidden');
            document.getElementById('imageSec').classList.add('hidden');
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('solidSec').classList.add('hidden');
            document.getElementById('imageSec').classList.remove('hidden');
        }
    }

    // Rang o'zgarganda hisoblash
    function updateColor(r, g, b) {
        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        currentData.hex = hex;
        currentData.rgb = `${r}, ${g}, ${b}`;
        currentData.hsl = rgbToHsl(r, g, b);
        currentData.cmyk = rgbToCmyk(r, g, b);

        preview.style.background = hex;
        hexDisplay.innerText = hex;
        nativeColor.value = hex;
        
        document.getElementById('rgbVal').innerText = currentData.rgb;
        document.getElementById('hslVal').innerText = currentData.hsl;
        document.getElementById('cmykVal').innerText = currentData.cmyk;
        
        // Telegram tugmasi rangini ham o'zgartirish (chiroyli bo'lishi uchun)
        tg.MainButton.setParams({
            color: hex,
            text_color: (r*0.299 + g*0.587 + b*0.114) > 186 ? '#000000' : '#ffffff'
        });
    }

    // Oddiy palitradan o'zgartirish
    nativeColor.addEventListener('input', (e) => {
        const r = parseInt(e.target.value.substr(1,2), 16);
        const g = parseInt(e.target.value.substr(3,2), 16);
        const b = parseInt(e.target.value.substr(5,2), 16);
        updateColor(r, g, b);
    });

    // Rasm yuklash va chizish
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                canvas.width = 320;
                canvas.height = 320 * (img.height / img.width);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.style.display = 'block';
                
                // Dominant palitra (AI)
                try {
                    const pal = colorThief.getPalette(img, 6);
                    const pBox = document.getElementById('paletteBox');
                    pBox.innerHTML = '';
                    pal.forEach(c => {
                        const d = document.createElement('div');
                        d.className = 'p-item';
                        d.style.background = `rgb(${c[0]},${c[1]},${c[2]})`;
                        d.onclick = () => updateColor(c[0], c[1], c[2]);
                        pBox.appendChild(d);
                    });
                } catch(err) {}
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    });

    // Pipetka (Rasm ustiga bosganda)
    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const data = ctx.getImageData(e.clientX - rect.left, e.clientY - rect.top, 1, 1).data;
        updateColor(data[0], data[1], data[2]);
    });

    // Matematik konvertorlar
    function rgbToHsl(r, g, b) {
        r/=255; g/=255; b/=255;
        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        let h, s, l = (max+min)/2;
        if(max===min){h=s=0} else {
            const d = max-min;
            s = l>0.5 ? d/(2-max-min) : d/(max+min);
            switch(max){ case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; }
            h/=6;
        }
        return `${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%`;
    }
    function rgbToCmyk(r,g,b){
        let c=1-(r/255), m=1-(g/255), y=1-(b/255), k=Math.min(c,m,y);
        c=(c-k)/(1-k)||0; m=(m-k)/(1-k)||0; y=(y-k)/(1-k)||0;
        return `${Math.round(c*100)}, ${Math.round(m*100)}, ${Math.round(y*100)}, ${Math.round(k*100)}`;
    }
</script>
</body>
</html>